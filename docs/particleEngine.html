<!DOCTYPE html>

<html>
<head>
  <title>particleEngine.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>particleEngine.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(root, undefined)</span> </span>{<span class="hljs-pi">

  "use strict"</span>;




<span class="hljs-keyword">var</span> <span class="hljs-built_in">document</span> = root.document || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>The global function, where ‘context’ parameter is required to be an instance of CanvasRenderingContext2D
usage:</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <pre><code> <span class="hljs-keyword">var</span> engine = particles(ctx);
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> particles = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(context)</span> </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> context === <span class="hljs-string">'undefined'</span>  || !(context <span class="hljs-keyword">instanceof</span> root.CanvasRenderingContext2D)){
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'particles must be defined with a canvas context'</span>);
    }


    <span class="hljs-keyword">var</span> _context = context;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>An extend function, automatically makes deep copies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">extend</span><span class="hljs-params">(dest, sources)</span></span>{
        <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; args.length; i++){
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> args[i]){
                <span class="hljs-keyword">if</span>(args[i].hasOwnProperty(key)){
                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> args[i][key] === <span class="hljs-string">'object'</span> &amp;&amp; (args[i][key] <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) === <span class="hljs-literal">false</span>){
                        dest[key] = dest[key] || {};
                        extend(dest[key], args[i][key]);
                    }<span class="hljs-keyword">else</span>{
                        dest[key] = args[i][key];
                    }
                }
            }
        }
        <span class="hljs-keyword">return</span> dest;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>turn hex to rgb, this is necessary for DAT gui, there’s some kind of bug that causes it to assign a color to a hex value sometimes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hexToRgb</span><span class="hljs-params">(hex)</span> </span>{
        <span class="hljs-keyword">var</span> result = <span class="hljs-regexp">/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i</span>.exec(hex);
        <span class="hljs-keyword">return</span> result ? {
            r: <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>),
            g: <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">2</span>], <span class="hljs-number">16</span>),
            b: <span class="hljs-built_in">parseInt</span>(result[<span class="hljs-number">3</span>], <span class="hljs-number">16</span>)
        } : <span class="hljs-literal">null</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Generate number at random between min and max</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">minMax</span><span class="hljs-params">(min, max)</span></span>{
        <span class="hljs-keyword">return</span> (min) + (<span class="hljs-built_in">Math</span>.random() * (max - min));
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">particleVariation</span><span class="hljs-params">(particle)</span></span>{
        particle.direction = minMax(particle.direction, particle.spread);

        particle.speed.x += <span class="hljs-built_in">Math</span>.random()*particle.speed.spread;
        particle.speed.y += <span class="hljs-built_in">Math</span>.random()*particle.speed.spread;

        particle.size.x += <span class="hljs-built_in">Math</span>.random()*particle.size.spread;
        particle.size.y += <span class="hljs-built_in">Math</span>.random()*particle.size.spread;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>for a dat gui bug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> particle.color === <span class="hljs-string">'string'</span>){
            <span class="hljs-keyword">var</span> colors = hexToRgb(particle.color);
            particle.color = [colors.r, colors.g, colors.b];
        }
        particle.color = particle.color.map(<span class="hljs-built_in">Math</span>.floor);

        <span class="hljs-keyword">return</span> particle;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>pre-defined particle types, used with an emitter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> particleTypes = {

        flame :
        {<span class="hljs-string">"weight"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"direction"</span>:<span class="hljs-number">1.8016922886691076</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">1.1780295733605703</span>,<span class="hljs-string">"position"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"speed"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0.6</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0.6</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">1.6</span>},<span class="hljs-string">"gravity"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"gravityCount"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"color"</span>:[<span class="hljs-number">250</span>,<span class="hljs-number">117.64705882352948</span>,<span class="hljs-number">0</span>],<span class="hljs-string">"size"</span>:{<span class="hljs-string">"height"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"width"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">3.3672395650648896</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">2.1</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">2</span>},<span class="hljs-string">"sprite"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"shape"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"alpha"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"decay"</span>:<span class="hljs-number">73</span>},
        water :
            {<span class="hljs-string">"weight"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"direction"</span>:<span class="hljs-number">2.286763289464637</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">2.286763289464637</span>,<span class="hljs-string">"position"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"speed"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">2.4</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">2.8</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">2</span>},<span class="hljs-string">"gravity"</span>:<span class="hljs-number">9</span>,<span class="hljs-string">"gravityCount"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"color"</span>:[<span class="hljs-number">43.627450980392155</span>,<span class="hljs-number">138.32468281430226</span>,<span class="hljs-number">222.5</span>],<span class="hljs-string">"size"</span>:{<span class="hljs-string">"height"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"width"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">3.4439461883408073</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">8.035874439461884</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">2.244826376709926</span>},<span class="hljs-string">"sprite"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"shape"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"alpha"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"decay"</span>:<span class="hljs-number">388</span>},
        smoke :
            {<span class="hljs-string">"weight"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"direction"</span>:<span class="hljs-number">1.1780295733605703</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">1.8016922886691076</span>,<span class="hljs-string">"position"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"speed"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0.79</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0.6</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">0.4</span>},<span class="hljs-string">"gravity"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"gravityCount"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"color"</span>:[<span class="hljs-number">23.455882352941163</span>,<span class="hljs-number">25.596885813148777</span>,<span class="hljs-number">27.499999999999986</span>],<span class="hljs-string">"size"</span>:{<span class="hljs-string">"height"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"width"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">3.3672395650648896</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">2.244826376709926</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">1.122413188354963</span>},<span class="hljs-string">"sprite"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"shape"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"alpha"</span>:<span class="hljs-number">0.24263312079958643</span>,<span class="hljs-string">"decay"</span>:<span class="hljs-number">295</span>},
        explode:
            {<span class="hljs-string">"weight"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"direction"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">6.283185307179586</span>,<span class="hljs-string">"position"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"speed"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">3</span>},<span class="hljs-string">"gravity"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"gravityCount"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"color"</span>:[<span class="hljs-number">255</span>,<span class="hljs-number">65</span>,<span class="hljs-number">65</span>],<span class="hljs-string">"size"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">5</span>},<span class="hljs-string">"sprite"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"shape"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"alpha"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"decay"</span>:<span class="hljs-number">228</span>},
        snow:
            {<span class="hljs-string">"weight"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"direction"</span>:<span class="hljs-number">3.949863863620736</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">5.474372723263827</span>,<span class="hljs-string">"position"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0</span>},<span class="hljs-string">"speed"</span>:{<span class="hljs-string">"x"</span>:<span class="hljs-number">0.6</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">0.6</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">0.4</span>},<span class="hljs-string">"gravity"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"gravityCount"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"color"</span>:<span class="hljs-string">"#ffffff"</span>,<span class="hljs-string">"size"</span>:{<span class="hljs-string">"height"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"width"</span>:<span class="hljs-number">0</span>,<span class="hljs-string">"spread"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"x"</span>:<span class="hljs-number">2.5</span>,<span class="hljs-string">"y"</span>:<span class="hljs-number">2</span>},<span class="hljs-string">"sprite"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"shape"</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">"alpha"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"decay"</span>:<span class="hljs-number">449</span>},

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>The full list of properties that the engine expects a particle to have.</p>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Because this is a base object, all user supplied (and pre-defined) particle types are extended over this into a new object
in the fashion of:</p>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <pre><code> extend({}, particle, userDefinedObject)
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>where extend automatically preforms a deep copy of all objects.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

    <span class="hljs-keyword">var</span> particle = {
        direction : <span class="hljs-number">0</span>,          <span class="hljs-comment">//-Direction particle is facing in radians. (minimum to spread)</span>
        spread: <span class="hljs-number">0</span>,              <span class="hljs-comment">//-The max spread of direction. where a particle is given a direction randomly between particle.direction and particle.spread</span>
        position : {            <span class="hljs-comment">//-An object containg the particles coordinates</span>
            x: <span class="hljs-number">0</span>,               <span class="hljs-comment">// -The x coordinate of the particle</span>
            y: <span class="hljs-number">0</span>                <span class="hljs-comment">// -The y coordinate of the particle</span>
        },
        speed: {                <span class="hljs-comment">//-An object containing speeds for both axis and a spread modifier.</span>
            x: <span class="hljs-number">0</span>,               <span class="hljs-comment">//-The speed the particle moves on the x-axis</span>
            y: <span class="hljs-number">0</span>,               <span class="hljs-comment">//-The speed the particle moves on the y-axis</span>
            spread: <span class="hljs-number">0</span>           <span class="hljs-comment">//-Math.random() * particle.speed..spread, applied to speed.x &amp; speed.y</span>
        },
        gravity : <span class="hljs-number">0</span>,            <span class="hljs-comment">//-The maximum amount of speed to apply to the y-axis</span>
        gravityCount:<span class="hljs-number">0</span>,
        color : [],             <span class="hljs-comment">//-[r,g,b] value.</span>
        size: {                 <span class="hljs-comment">//-An object contained height, width and spread properties for the size</span>
            height: <span class="hljs-number">0</span>,          <span class="hljs-comment">//-The height of the particle</span>
            width: <span class="hljs-number">0</span>,           <span class="hljs-comment">//-The width of the particle</span>
            spread: <span class="hljs-number">0</span>           <span class="hljs-comment">//-Math.random()*particle.size.spread applied to both x &amp; y</span>
        },
        sprite: <span class="hljs-literal">false</span>,          <span class="hljs-comment">//not implemented</span>
        shape: <span class="hljs-literal">false</span>,           <span class="hljs-comment">//not implemented</span>
        alpha: <span class="hljs-number">0</span>,               <span class="hljs-comment">//-The starting opacity of a particle</span>
        decay: <span class="hljs-number">0</span>                <span class="hljs-comment">//-The lifetime of the particle</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>defaults for the collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> collectionDefaults = {
        max: <span class="hljs-number">100</span> ,              <span class="hljs-comment">//the maximum amount of particles allowed in a collection</span>
        density: <span class="hljs-number">1</span>,             <span class="hljs-comment">//the amount ofparticles placed into the collection every cycle</span>
        cycleOnce: <span class="hljs-literal">false</span>,       <span class="hljs-comment">//flag to determine if the collection cycles continuously or only once</span>
        cycleCount: <span class="hljs-number">0</span>,          <span class="hljs-comment">//keeps track of the amount of particles added to the collection after cycleOnce has been set to true</span>
        finished : <span class="hljs-literal">false</span>,       <span class="hljs-comment">//flag set to true when cycle has finished</span>
        stopped: <span class="hljs-literal">false</span>          <span class="hljs-comment">//determines whether or not the particles are rendered</span>
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>A collection holds an array of particles and contains functions to preform actions on them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> collection = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(emitter, args)</span></span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> emitter === <span class="hljs-string">'undefined'</span>){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Emitter needs to be passed to a collection"</span>);
        }

        <span class="hljs-keyword">var</span> particleArr = [],
            properties = extend({}, collectionDefaults, args);

        <span class="hljs-keyword">return</span> {
            properties : properties,
            emitter : extend({},emitter),
            exportParticle : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
                <span class="hljs-keyword">return</span> root.JSON.stringify(<span class="hljs-keyword">this</span>.emitter.particle);
            },
            cycle : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
                    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
                    <span class="hljs-keyword">if</span>( (<span class="hljs-keyword">this</span>.numParticles()&lt;<span class="hljs-keyword">this</span>.properties.max) &amp;&amp; !<span class="hljs-keyword">this</span>.properties.finished ){
                        <span class="hljs-keyword">while</span>(i++ <span class="xml"><span class="hljs-tag">&lt; <span class="hljs-attribute">this.properties.density</span> ){
                            <span class="hljs-attribute">if</span>(<span class="hljs-attribute">this.properties.cycleOnce</span>){
                                <span class="hljs-attribute">this.properties.cycleCount</span>++;
                            }
                            <span class="hljs-attribute">this.addParticle</span>();
                            <span class="hljs-attribute">if</span>(<span class="hljs-attribute">this.properties.cycleCount</span> &gt;</span>= this.properties.max &amp;&amp; this.properties.cycleOnce){
                                this.properties.finished = true;
                            }
                        }
                    }
            },
            reset : function(){
                particleArr = [];
                _context.clearRect(0,0,_context.canvas.width, _context.canvas.height);
                this.properties.finished = false;
                this.properties.cycleCount = 0;
            },
            addParticle : function(){

                var _particle = extend({}, particle, this.emitter.particle);
</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>this is where we give particles the variation through all of the various spreads</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                _particle = particleVariation(_particle);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>place particle based on emitter height / width</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                 <span class="hljs-keyword">var</span> org = {
                        x: minMax(<span class="hljs-keyword">this</span>.emitter.properties.origin.x, <span class="hljs-keyword">this</span>.emitter.properties.origin.x + <span class="hljs-keyword">this</span>.emitter.properties.width),
                        y: minMax(<span class="hljs-keyword">this</span>.emitter.properties.origin.y, <span class="hljs-keyword">this</span>.emitter.properties.origin.y + <span class="hljs-keyword">this</span>.emitter.properties.height)
                    };
                extend(_particle.position, org);

                particleArr.push(_particle);

            },
            getParticle : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span></span>{
                <span class="hljs-keyword">return</span> particleArr[i];
            },
            numParticles : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
                <span class="hljs-keyword">return</span> particleArr.length;
            },
            draw : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
                <span class="hljs-comment">/*
                This is the top level loop inside the library
                    requestAnimationFrame()-&gt;draw()-&gt;cycle()-&gt;-&gt;addParticle()
                by checking for stopped here, we eliminate i iterations every call by requestAnimationFrame (16ms!)
                 */</span>
                <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.properties.stopped){
                    <span class="hljs-keyword">this</span>.cycle();</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p><a href="http://jsperf.com/for-loops22/2">http://jsperf.com/for-loops22/2</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, j = particleArr.length, particle; particle = particleArr[i]; i++){<span class="hljs-comment">//jshint ignore:line</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>move particle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        particle.position.x += (particle.speed.x) * <span class="hljs-built_in">Math</span>.cos(particle.direction);
                        particle.position.y -= (particle.speed.y) * <span class="hljs-built_in">Math</span>.sin(particle.direction);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>gravity</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span>(particle.gravityCount &lt; particle.gravity){
                            particle.gravityCount += particle.gravity*<span class="hljs-number">0.025</span>;
                        }
                        particle.position.y += particle.gravityCount;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>get particle distance from origin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">var</span> diffX = particle.position.x - (<span class="hljs-keyword">this</span>.emitter.properties.origin.x + <span class="hljs-keyword">this</span>.emitter.properties.width),
                            diffY = particle.position.y - (<span class="hljs-keyword">this</span>.emitter.properties.origin.y + <span class="hljs-keyword">this</span>.emitter.properties.height),
                            distance = <span class="hljs-built_in">Math</span>.sqrt((diffX*diffX)+(diffY*diffY));</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>decay particle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">var</span> trueAlpha = particle.alpha - (distance / particle.decay);

                        <span class="hljs-keyword">if</span>(trueAlpha &lt;= <span class="hljs-number">0</span>){
                            particleArr.splice(i, <span class="hljs-number">1</span>);
                        }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>draw particle
todo: shape, sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
                        _context.fillStyle = <span class="hljs-string">"rgba("</span>+particle.color.join()+<span class="hljs-string">","</span>+trueAlpha +<span class="hljs-string">")"</span>;

                        _context.beginPath();
                        _context.arc(
                            particle.position.x,
                            particle.position.y,
                            (particle.size.x * particle.size.y /<span class="hljs-number">2</span>),
                            <span class="hljs-number">0</span>,
                                <span class="hljs-built_in">Math</span>.PI*<span class="hljs-number">2</span>,
                            <span class="hljs-literal">true</span>
                        );
                        _context.closePath();
                        _context.fill();
                    }
                }

            },
            setProp : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prop, val)</span></span>{

                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span>.properties[prop] === <span class="hljs-string">'undefined'</span>){
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'could not find collection property: '</span>+prop);
                }<span class="hljs-keyword">else</span>{
                    <span class="hljs-keyword">switch</span>(prop){
                        <span class="hljs-keyword">case</span> <span class="hljs-string">'max'</span> :
                            <span class="hljs-keyword">this</span>.properties.max = val;
                            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.properties.cycleOnce){
                                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.properties.finished){
                                    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.properties.max &gt; <span class="hljs-keyword">this</span>.properties.cycleCount){
                                        <span class="hljs-keyword">this</span>.properties.finished = <span class="hljs-literal">false</span>;
                                    }<span class="hljs-keyword">else</span>{
                                        <span class="hljs-keyword">this</span>.properties.cycleCount = <span class="hljs-keyword">this</span>.properties.max;
                                    }
                                }
                            }
                            <span class="hljs-keyword">break</span>;
                        <span class="hljs-keyword">default</span> :
                            <span class="hljs-keyword">this</span>.properties[prop] = val;
                    }
                }
            },
            getProp : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(prop)</span></span>{
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.properties[prop];
            }
        };
    };

    <span class="hljs-comment">/*

     An emitter describes the behavior of individual particles

     */</span>
    <span class="hljs-keyword">var</span> emitter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(_particle, properties)</span></span>{
        <span class="hljs-keyword">var</span> props = {
            origin : {
                x: <span class="hljs-number">0</span>,
                y: <span class="hljs-number">0</span>
            },
            height : <span class="hljs-number">1</span>,
            width:<span class="hljs-number">1</span>
        }, type, _p;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>        props = extend({}, props, properties);

        <span class="hljs-keyword">var</span> setParticle = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span>{
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> p === <span class="hljs-string">'string'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>user supplied a string, look for a pre-defined particle</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                type = particleTypes[p];
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> particleTypes[p] === <span class="hljs-string">'undefined'</span>){
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(p+<span class="hljs-string">" Does not exist"</span>);
                }
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> p === <span class="hljs-string">'undefined'</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>pointless to instantiate further, the default particle object has no usable properties</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Undefined particle type"</span>);
            }
            <span class="hljs-keyword">else</span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>For now we’ll assume that the user supplied an object, todo: more strict type checking
we extend the user supplied object into the particle object to at least ensure that all the defaults are there todo: validate this particle
we extend this object into a new object to so that the defaults aren’t altered and we’re dealing with a fresh object and not a reference.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                type = p;
            }
            _p = extend({}, particle, type);
        };
        setParticle(_particle);


        <span class="hljs-keyword">return</span> {
            properties : props,
            particle: _p,
            setOrigin: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(x,y)</span></span>{
                <span class="hljs-keyword">this</span>.properties.origin.x = x;
                <span class="hljs-keyword">this</span>.properties.origin.y = y;
            },
            setParticle : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span>{
                setParticle(p);
                extend(<span class="hljs-keyword">this</span>.particle,_p);
            }
        };
    };

    <span class="hljs-comment">/*
     Limit access to the inside functions
     */</span>
    <span class="hljs-keyword">return</span> {
        collection : collection,
        emitter : emitter,
        updateContext : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(context)</span></span>{
            _context = context;
        }
    };
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Version.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>particles.VERSION = <span class="hljs-string">'0.2.0'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Export to the root, which is probably <code>window</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>root.particles = particles;

}(<span class="hljs-keyword">this</span>));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
